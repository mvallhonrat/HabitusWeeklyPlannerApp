<!DOCTYPE html>

<html lang="es">
<head>
<!-- Etiquetas Open Graph para redes sociales -->
<meta content="Habitus - Planificador Semanal" property="og:title"/>
<meta content="Organiza tu semana con claridad y propósito con Habitus." property="og:description"/>
<meta content="https://mvallhonrat.github.io/HabitusWeeklyPlannerApp/icons/icon-514x5154.png" property="og:image"/>
<meta content="website" property="og:type"/>
<meta content="https://mvallhonrat.github.io/HabitusWeeklyPlannerApp/" property="og:url"/>
<!-- Etiquetas Twitter Card -->
<meta content="summary_large_image" name="twitter:card"/>
<meta content="Habitus - Planificador Semanal" name="twitter:title"/>
<meta content="Organiza tu semana con claridad y propósito con Habitus." name="twitter:description"/>
<meta content="https://mvallhonrat.github.io/HabitusWeeklyPlannerApp/icons/icon-514x5154.png" name="twitter:image"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="#4f46e5" name="theme-color"/>
<meta content="Planificador Semanal basado en la Matriz de Prioridades" name="description"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<title data-i18n="title">Habitus - Planificador Semanal</title>
<!-- Cargar Tailwind CSS desde CDN -->
<div class="bg-white rounded-lg shadow-md p-4 mb-6 max-w-2xl mx-auto text-center">
<div class="flex justify-center mb-4 px-4 sm:px-6">
<div class="flex flex-col items-center justify-center mb-4 px-4 text-center">
<img alt="Logo Habitus" class="w-24 h-24 object-contain mb-2" src="icons/icon-192x192.png"/>
<h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-1" data-i18n="title">Planificador Semanal</h1>
</div>
</div>
<div class="mb-6" id="pasaje-inspirador">
<div class="text-gray-700 text-center mt-2" id="verso-contenedor">
<!-- El versículo aleatorio se cargará aquí dinámicamente -->
</div>
</div></div><script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3"></script>
<link href="manifest.json" rel="manifest"/>
<link href="icons/icon-192x192.png" rel="apple-touch-icon"/>
<style>
    /* Optimizaciones para móvil */
    @media (max-width: 640px) {
      .text-2xl {
        font-size: 1.5rem;
      }
      .text-xl {
        font-size: 1.25rem;
      }
      .p-4 {
        padding: 0.75rem;
      }
      /* Aumentar tamaño de elementos interactivos para móvil */
      button, input[type="text"], select, textarea {
        min-height: 44px;
      }
      /* Aumentar espaciado entre elementos */
      .space-y-1 > * + * {
        margin-top: 0.5rem;
      }
    }

    /* Mejorar rendimiento táctil */
    .touch-manipulation {
      touch-action: manipulation;
    }

    /* Prevenir selección de texto en elementos interactivos */
    .no-select {
      user-select: none;
    }

    /* Estilos para modo standalone en iOS */
    @supports (-webkit-touch-callout: none) {
      .ios-standalone {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }
    }
  </style>
<link rel="stylesheet" href="styles.css">
<link href="./icons/icon-192x192.png" rel="icon" type="image/png"/></head>
<body class="bg-gray-50 text-gray-800 p-4 antialiased ios-standalone">
<div class="absolute top-4 right-4 text-sm text-gray-600" id="langSelector">
<button class="mx-1 text-xl" onclick="setLanguage('es')" title="Español">🇪🇸</button>
<button class="mx-1 text-xl" onclick="setLanguage('en')" title="English">🇺🇸</button>
</div>
<!-- Título principal -->
<!-- Recuadro de instrucciones - Colapsable en móvil -->
<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-900 p-3 mb-4 rounded">
<div class="flex items-center cursor-pointer gap-2" onclick="toggleInstructions()">
<button class="text-blue-700 hover:text-blue-900" id="instructionsToggle">▼</button>
<h3 class="font-medium no-select" data-i18n="instructions_title">📖 Instrucciones de uso</h3>
</div>
<div class="mt-2" id="instructionsContent">
<ul class="list-disc list-inside text-sm space-y-2">
<li data-i18n="inst_1">🎭 <strong>Define tus Roles:</strong> Identifica los roles importantes en tu vida (por ejemplo: Padre, Profesional, Amigo). Estos serán las categorías bajo las cuales organizarás tus tareas semanales.</li>
<li data-i18n="inst_2">📝 <strong>Agrega tus Tareas:</strong> Para cada rol, añade las tareas que deseas realizar esta semana. Escribe una breve descripción y asigna el cuadrante correspondiente según su urgencia e importancia.</li>
<li data-i18n="inst_3">🔢 Prioriza con los Cuadrantes: Utiliza la Matriz de Prioridades (I-IV) para clasificar cada tarea:</li><div class="ml-6 mt-1 text-sm" data-i18n="inst_3_sub"></div>
<li data-i18n="inst_8">✅ <strong>Marca las Completadas:</strong> A medida que termines cada tarea, márcala como realizada con la casilla de verificación.</li>
<li data-i18n="inst_9">🔄 <strong>Vista de Roles/Cuadrantes:</strong> Alterna entre la vista agrupada por roles o por cuadrantes usando las pestañas para obtener diferentes perspectivas de tus tareas.</li>
<li data-i18n="inst_10">📊 <strong>Revisa tus Métricas:</strong> Al finalizar la semana, revisa el resumen de tareas completadas y pendientes, y reflexiona sobre tu semana en Revisión Semanal.</li>
<li data-i18n="inst_11">📋 <strong>Exporta y Reinicia:</strong> Guarda un registro de tu semana utilizando Exportar Métricas y Exportar Tareas. Luego comienza una nueva semana con el botón Nueva Semana: solo las tareas completadas se removerán, las pendientes permanecerán para la siguiente semana.</li>
</ul>
</div>
</div>
<!-- Sección de Roles -->
<div class="mb-6">
<h2 class="text-xl font-semibold mb-2 no-select" data-i18n="roles">🎭 Definir Roles</h2>
<div class="flex gap-2">
<input class="border rounded px-3 py-2 flex-1 touch-manipulation" data-i18n-placeholder="placeholder_role" id="roleInput" placeholder="Nuevo rol..." type="text"/>
<button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 active:bg-blue-700 touch-manipulation" data-i18n="add_role" id="addRoleBtn" onclick="addRole()">
        ➕ Añadir Rol
      </button>
</div>
<div class="mt-2 space-y-1" id="rolesList"><!-- Lista de roles dinámicos --></div>
</div>
<!-- Controles: pestañas y formulario -->
<div class="mb-4">
<!-- Pestañas Roles / Cuadrantes -->
<div class="flex border-b border-gray-300 mb-3 no-select">
<button class="flex-1 px-3 py-3 text-sm font-medium text-gray-700 border-b-2 border-indigo-500 touch-manipulation" data-i18n="tabs_roles" id="tabRoles" onclick="showRoles()">Por Roles</button>
<button class="flex-1 px-3 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 border-b-2 border-transparent touch-manipulation" data-i18n="tabs_quadrants" id="tabQuadrants" onclick="showQuadrants()">Por Cuadrantes</button>
</div>
<!-- Recordatorio de la última revisión -->
<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-900 p-3 mb-4 text-sm italic hidden" id="lastReviewBox">
      📌 <strong>Recuerda esto de la semana anterior:</strong> <span id="lastReviewText"></span>
</div>
<!-- Formulario de nueva tarea -->
<div class="mb-2">
<label class="block text-sm font-medium mb-1" data-i18n="label_task" for="taskInput">Nueva Tarea:</label>
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">
<input class="border rounded px-3 py-2 text-sm w-full touch-manipulation" data-i18n-placeholder="placeholder_task" id="taskInput" placeholder="Descripción de la tarea" type="text"/>
<select class="border rounded px-3 py-2 text-sm w-full touch-manipulation" id="roleSelect">
<option disabled="" selected="" value="">Rol</option>
</select>
<select class="border rounded px-3 py-2 text-sm w-full touch-manipulation" id="quadrantSelect">
<option disabled="" selected="" value="">Cuadrante</option>
<option value="1">I - Urgente/Importante</option>
<option value="2">II - No Urgente/Importante</option>
<option value="3">III - Urgente/No Importante</option>
<option value="4">IV - No Urgente/No Importante</option>
</select>
<button class="bg-green-500 text-white text-sm px-3 py-2 rounded hover:bg-green-600 active:bg-green-700 w-full touch-manipulation" data-i18n="add_task_button" onclick="addTask()">
          ✔️ Añadir Tarea
        </button>
</div>
</div>
</div>
<!-- Vistas de tareas -->
<div class="mb-6 overflow-x-hidden" id="rolesView"></div>
<div class="mb-6 hidden overflow-x-hidden" id="quadrantsView"></div>
<!-- Sección de gráficos -->
<div class="mb-6">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-lg font-semibold mb-2" data-i18n="metric_quadrants">Tareas por Cuadrante</h3>
<div class="w-full h-[300px]">
<canvas id="chartQuadrants"></canvas>
</div>
</div>
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-lg font-semibold mb-2" data-i18n="chart_title_completion">Completadas vs Pendientes</h3>
<div class="w-full h-[300px]">
<canvas id="chartCompletion"></canvas>
</div>
</div>
</div>
</div>
<!-- Sección de revisión y controles -->
<div class="mb-4">
<label class="block text-sm font-medium mb-1" data-i18n="label_review" for="reviewInput">📝 Revisión semanal:</label>
<textarea class="w-full border rounded px-3 py-2 text-sm touch-manipulation" data-i18n-placeholder="placeholder_review" id="reviewInput" placeholder="Escribe aquí una reflexión sobre tu semana..." rows="3"></textarea>
<button class="mt-3 bg-purple-600 text-white text-sm font-medium px-4 py-3 rounded hover:bg-purple-700 active:bg-purple-800 w-full sm:w-auto touch-manipulation" data-i18n="new_week" id="newWeekBtn" onclick="newWeek()">
      🌅 Nueva Semana
    </button>
</div>
<!-- Sección de métricas históricas -->
<div class="mb-6">
<h2 class="text-xl font-semibold mb-4">📊 Métricas Históricas</h2>
<!-- Resumen de métricas actuales -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-sm font-medium text-gray-500" data-i18n="metric_total">Total de Tareas</h3>
<p class="text-2xl font-bold" id="totalTasks">0</p>
</div>
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-sm font-medium text-gray-500" data-i18n="metric_percent">Porcentaje Completado</h3>
<p class="text-2xl font-bold" id="completionPercentage">0%</p>
</div>
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-sm font-medium text-gray-500" data-i18n="metric_roles">Roles Activos</h3>
<p class="text-2xl font-bold" id="activeRoles">0</p>
</div>
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-sm font-medium text-gray-500" data-i18n="metric_quadrants">Tareas por Cuadrante</h3>
<div class="grid grid-cols-2 gap-2 mt-2">
<div>
<span class="text-xs text-red-500">Q1:</span>
<span class="text-sm font-medium" id="q1Count">0</span>
</div>
<div>
<span class="text-xs text-green-500">Q2:</span>
<span class="text-sm font-medium" id="q2Count">0</span>
</div>
<div>
<span class="text-xs text-yellow-500">Q3:</span>
<span class="text-sm font-medium" id="q3Count">0</span>
</div>
<div>
<span class="text-xs text-gray-500">Q4:</span>
<span class="text-sm font-medium" id="q4Count">0</span>
</div>
</div>
</div>
</div>
<!-- Gráficos históricos -->
<div class="grid grid-cols-1 gap-4">
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-lg font-semibold mb-2" data-i18n="chart_completion_title">Porcentaje de Completado por Semana</h3>
<div class="w-full h-[300px]">
<canvas id="chartHistoricalCompletion"></canvas>
</div>
</div>
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-lg font-semibold mb-2" data-i18n="chart_quadrants_title">Tareas por Cuadrante por Semana</h3>
<div class="w-full h-[300px]">
<canvas id="chartHistoricalQuadrants"></canvas>
</div>
</div>
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-lg font-semibold mb-2" data-i18n="chart_roles_title">Roles Activos por Semana</h3>
<div class="w-full h-[300px]">
<canvas id="chartHistoricalRoles"></canvas>
</div>
</div>
</div>
</div>
<!-- Botones de exportación -->
<div class="mb-4 grid grid-cols-2 gap-2">
  <button class="bg-gray-300 text-gray-800 text-sm px-4 py-3 rounded hover:bg-gray-400 active:bg-gray-500 touch-manipulation" data-i18n="export_metrics" onclick="exportCSV('metrics')">
    📥 Exportar Métricas
  </button>
  <button class="bg-gray-300 text-gray-800 text-sm px-4 py-3 rounded hover:bg-gray-400 active:bg-gray-500 touch-manipulation" data-i18n="export_tasks" onclick="exportCSV('tasks')">
    📥 Exportar Tareas
  </button>
</div>
<!-- Botón de migración -->
<div class="mb-4">
  <button id="migrateDataBtn" class="bg-blue-500 text-white text-sm px-4 py-3 rounded hover:bg-blue-600 active:bg-blue-700 w-full touch-manipulation">
    🔄 Migrar Datos Existentes
  </button>
</div>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3"></script>
<script src="app.js" defer></script>
<script src="translations.json" type="application/json" id="translations-data"></script>
<script src="passages.json" type="application/json" id="passages-data"></script>

<!-- Remove the inline translations and passages scripts -->
<script data-i18n="no_tasks">
  // Variables globales
  let roles = [];
  let tasks = [];
  let metrics = [];    // histórico semanal de métricas
  let tasksLog = [];   // histórico de tareas
  let lastReviewText = "";  // última reflexión guardada
  let lastResetTime = null; // timestamp de último "Nueva Semana"
  let chartQuadrants = null;
  let chartCompletion = null;
  let chartHistoricalCompletion = null;
  let chartHistoricalQuadrants = null;
  let chartHistoricalRoles = null;

  // === Cargar datos de localStorage (si existen) al iniciar ===
  (function loadData() {
    const storedRoles = localStorage.getItem("habitus_roles");
    const storedTasks = localStorage.getItem("habitus_tasks");
    const storedMetrics = localStorage.getItem("habitus_metrics");
    const storedTasksLog = localStorage.getItem("habitus_tasksLog");
    const storedLastReview = localStorage.getItem("habitus_lastReview");
    const storedLastReset = localStorage.getItem("habitus_lastReset");

    if(storedRoles) roles = JSON.parse(storedRoles);
    if(storedTasks) tasks = JSON.parse(storedTasks);
    if(storedMetrics) metrics = JSON.parse(storedMetrics);
    if(storedTasksLog) tasksLog = JSON.parse(storedTasksLog);
    if(storedLastReview) lastReviewText = JSON.parse(storedLastReview);
    if(storedLastReset) lastResetTime = parseInt(storedLastReset);

    // Poblar dropdown de roles
    updateRoleOptions();
    
    // Mostrar última revisión si existe
    if(lastReviewText && lastReviewText.trim() !== "") {
      const lastReviewBox = document.getElementById("lastReviewBox");
      const lastReviewSpan = document.getElementById("lastReviewText");
      lastReviewSpan.textContent = lastReviewText;
      lastReviewBox.style.display = "block";
    }
  })();

  // === Función para actualizar las opciones del select de roles ===
  function updateRoleOptions() {
    const roleSelect = document.getElementById("roleSelect");
    // Limpiar opciones actuales (excepto placeholder)
    roleSelect.innerHTML = '<option value="" disabled selected>Rol</option>';
    roles.forEach(role => {
      const opt = document.createElement("option");
      opt.value = role;
      opt.textContent = role;
      roleSelect.appendChild(opt);
    });
    
    renderRoleList();
  }

  // === Inicializar gráficos Chart.js ===
  function initCharts() {
    const ctxQ = document.getElementById('chartQuadrants').getContext('2d');
    const ctxC = document.getElementById('chartCompletion').getContext('2d');
    const ctxHC = document.getElementById('chartHistoricalCompletion').getContext('2d');
    const ctxHQ = document.getElementById('chartHistoricalQuadrants').getContext('2d');
    const ctxHR = document.getElementById('chartHistoricalRoles').getContext('2d');

    // Datos iniciales para gráficos
    const quadCounts = countTasksByQuadrant();
    const compCounts = countCompletedPending();
    const historicalData = prepareHistoricalData();

    // Configuración del gráfico de barras (Cuadrantes)
    chartQuadrants = new Chart(ctxQ, {
      type: 'bar',
      data: {
        labels: ['Q1', 'Q2', 'Q3', 'Q4'],
        datasets: [{
          label: 'Tareas',
          data: quadCounts,
          backgroundColor: ['#ef4444','#22c55e','#eab308','#9ca3af'] // rojo, verde, amarillo, gris
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { display: false }
        },
        scales: {
          x: { 
            ticks: { color: '#374151' },
            grid: { display: false }
          },
          y: { 
            beginAtZero: true, 
            ticks: { precision: 0, color: '#374151' },
            grid: { color: '#e5e7eb' }
          }
        }
      }
    });

    // Configuración del gráfico doughnut (Completadas vs Pendientes)
    chartCompletion = new Chart(ctxC, {
      type: 'doughnut',
      data: {
        labels: ['Completadas','Pendientes'],
        datasets: [{
          data: compCounts,
          backgroundColor: ['#4ade80', '#f87171'] // verde-400, rojo-400
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            position: 'bottom',
            labels: {
              boxWidth: 12,
              padding: 15
            }
          },
          title: { display: false }
        },
        cutout: '70%'
      }
    });

    // Configuración del gráfico de línea (Porcentaje de completado histórico)
    chartHistoricalCompletion = new Chart(ctxHC, {
      type: 'line',
      data: {
        labels: historicalData.labels,
        datasets: [{
          label: 'Porcentaje Completado',
          data: historicalData.completionPercentages,
          borderColor: '#4f46e5',
          backgroundColor: 'rgba(79, 70, 229, 0.1)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: value => value + '%'
            }
          }
        }
      }
    });

    // Configuración del gráfico de barras (Tareas por cuadrante histórico)
    chartHistoricalQuadrants = new Chart(ctxHQ, {
      type: 'bar',
      data: {
        labels: historicalData.labels,
        datasets: [
          {
            label: 'Q1',
            data: historicalData.q1Counts,
            backgroundColor: '#ef4444'
          },
          {
            label: 'Q2',
            data: historicalData.q2Counts,
            backgroundColor: '#22c55e'
          },
          {
            label: 'Q3',
            data: historicalData.q3Counts,
            backgroundColor: '#eab308'
          },
          {
            label: 'Q4',
            data: historicalData.q4Counts,
            backgroundColor: '#9ca3af'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' }
        },
        scales: {
          x: { stacked: true },
          y: { stacked: true }
        }
      }
    });

    // Configuración del gráfico de línea (Roles activos histórico)
    chartHistoricalRoles = new Chart(ctxHR, {
      type: 'line',
      data: {
        labels: historicalData.labels,
        datasets: [{
          label: 'Roles Activos',
          data: historicalData.activeRoles,
          borderColor: '#8b5cf6',
          backgroundColor: 'rgba(139, 92, 246, 0.1)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        }
      }
    });

    // Actualizar métricas actuales
    updateCurrentMetrics();
  }

  // === Función para renderizar la lista de roles ===
  function renderRoleList() {
    const rolesList = document.getElementById("rolesList");
    rolesList.innerHTML = ""; // Limpiar lista actual
    
    if(roles.length === 0) {
      rolesList.innerHTML = '<p class="text-sm text-gray-500">* No hay roles definidos *</p>';
      return;
    }
    
    roles.forEach((role, index) => {
      const roleItem = document.createElement("div");
      roleItem.className = "flex items-center justify-between bg-white p-2 rounded shadow-sm";
      roleItem.innerHTML = `
        <span class="text-sm">${role}</span>
        <button onclick="deleteRole(${index})" class="text-red-500 hover:text-red-700">
          🗑️
        </button>
      `;
      rolesList.appendChild(roleItem);
    });
  }

  // === Función para renderizar la lista de cuadrantes ===
  function renderQuadrantList() {
    // ... existing renderQuadrantList code ...
  }

  // === Función para añadir un nuevo rol ===
  function addRole() {
    // ... existing addRole code ...
  }

  // === Función para añadir una nueva tarea ===
  function addTask() {
    // ... existing addTask code ...
  }

  // === Función para marcar una tarea como completada ===
  function toggleTaskComplete(taskId) {
    // ... existing toggleTaskComplete code ...
  }

  // === Función para eliminar una tarea ===
  function deleteTask(taskId) {
    // ... existing deleteTask code ...
  }

  // === Función para guardar la revisión semanal ===
  function saveReview() {
    // ... existing saveReview code ...
  }

  // === Función para iniciar una nueva semana ===
  function startNewWeek() {
    // ... existing startNewWeek code ...
  }

  // === Función para exportar métricas ===
  function exportMetrics() {
    // ... existing exportMetrics code ...
  }

  // === Función para exportar tareas ===
  function exportTasks() {
    // ... existing exportTasks code ...
  }

  // === Función para contar tareas por cuadrante ===
  function countTasksByQuadrant() {
    // ... existing countTasksByQuadrant code ...
  }

  // === Función para contar tareas completadas y pendientes ===
  function countCompletedPending() {
    // ... existing countCompletedPending code ...
  }

  // === Función para preparar datos históricos ===
  function prepareHistoricalData() {
    // ... existing prepareHistoricalData code ...
  }

  // === Función para actualizar métricas ===
  function updateMetrics() {
    // ... existing updateMetrics code ...
  }

  // === Función para actualizar gráficos ===
  function updateCharts() {
    // ... existing updateCharts code ...
  }

  // === Función para actualizar gráficos históricos ===
  function updateHistoricalCharts() {
    // ... existing updateHistoricalCharts code ...
  }

  // === Función para actualizar resumen de métricas ===
  function updateMetricsSummary() {
    // ... existing updateMetricsSummary code ...
  }

  // === Función para actualizar el pasaje inspirador ===
  function updateInspirationalQuote() {
    // ... existing updateInspirationalQuote code ...
  }

  // === Función para aplicar traducciones ===
  function applyTranslations(lang) {
    // Load translations from external JSON file
    fetch('translations.json')
      .then(response => response.json())
      .then(data => {
        const t = data[lang] || data["es"]; // Fallback to Spanish if language not found

        // Update text content for elements with data-i18n attribute
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          if (t[key]) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
              el.value = t[key];
            } else {
              // For instruction items, preserve the HTML structure
              if (key.startsWith('inst_')) {
                el.innerHTML = t[key];
              } else {
                el.textContent = t[key];
              }
            }
          }
        });

        // Update placeholders
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
          const key = el.getAttribute('data-i18n-placeholder');
          if (t[key]) el.placeholder = t[key];
        });

        // Update chart titles and labels
        if (typeof chartQuadrants !== "undefined" && chartQuadrants) {
          chartQuadrants.options.plugins.title = {
            display: true,
            text: t.chart_title_quadrants
          };
          chartQuadrants.update();
        }

        if (typeof chartCompletion !== "undefined" && chartCompletion) {
          chartCompletion.data.labels = [t.metric_completed, t.metric_pending];
          chartCompletion.update();
        }

        if (typeof chartHistoricalCompletion !== "undefined" && chartHistoricalCompletion) {
          chartHistoricalCompletion.options.plugins.title = {
            display: true,
            text: t.chart_completion_title
          };
          chartHistoricalCompletion.update();
        }

        if (typeof chartHistoricalQuadrants !== "undefined" && chartHistoricalQuadrants) {
          chartHistoricalQuadrants.options.plugins.title = {
            display: true,
            text: t.chart_quadrants_title
          };
          chartHistoricalQuadrants.update();
        }

        if (typeof chartHistoricalRoles !== "undefined" && chartHistoricalRoles) {
          chartHistoricalRoles.options.plugins.title = {
            display: true,
            text: t.chart_roles_title
          };
          chartHistoricalRoles.update();
        }
      });
  }

  // === Función para establecer el idioma ===
  function setLanguage(lang) {
    localStorage.setItem("habitus_lang", lang);
    applyTranslations(lang);
    
    // Update inspirational quote
    fetch('passages.json')
      .then(response => response.json())
      .then(data => {
        const elegido = data[lang][Math.floor(Math.random() * data[lang].length)];
        document.getElementById("inspirationalQuote").textContent = elegido.contenido;
        document.getElementById("inspirationalPassage").textContent = elegido.pasaje;
      });
  }

  // === Inicialización ===
  document.addEventListener('DOMContentLoaded', function() {
    // Cargar datos guardados
    loadData();
    
    // Inicializar gráficos
    initCharts();
    
    // Actualizar métricas y gráficos
    updateMetrics();
    updateCharts();
    updateHistoricalCharts();
    updateMetricsSummary();
    
    // Actualizar pasaje inspirador
    updateInspirationalQuote();
    
    // Cargar idioma guardado o usar español por defecto
    const savedLang = localStorage.getItem("habitus_lang") || "es";
    setLanguage(savedLang);
    
    // Registrar service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
          console.log('ServiceWorker registration successful');
        })
        .catch(err => {
          console.log('ServiceWorker registration failed: ', err);
        });
    }
  });
</script>

<!-- Remove the inline passages script -->
<script>
  // ... existing code ...
</script>
