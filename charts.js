const translations = {
  "es": {
    "title": "Planificador Semanal",
    "subtitle": "Organiza tu semana con claridad y propósito",
    "new_task": "Nueva tarea",
    "add_task": "Añadir tarea",
    "roles": "Definir Roles",
    "review": "Revisión semanal",
    "new_week": "🌅 Nueva Semana",
    "export_metrics": "📥 Exportar Métricas",
    "export_tasks": "📥 Exportar Tareas",
    "instructions": "Instrucciones de uso",
    "tabs_roles": "Por Roles",
    "tabs_quadrants": "Por Cuadrantes",
    "inst_1": "🎭 <strong>Define tus Roles:</strong> Identifica los roles importantes en tu vida (por ejemplo: Padre, Profesional, Amigo). Estos serán las categorías bajo las cuales organizarás tus tareas semanales.",
    "inst_2": "📝 <strong>Agrega tus Tareas:</strong> Para cada rol, añade las tareas que deseas realizar esta semana. Escribe una breve descripción y asigna el cuadrante correspondiente según su urgencia e importancia.",
    "inst_3": "🔢 <strong>Prioriza con los Cuadrantes:</strong> Utiliza la Matriz de Prioridades (I-IV) para clasificar cada tarea:",
    "inst_3_sub": "<ul class='list-none ml-4 mt-1'><li>I – Urgente e Importante (hacer de inmediato).</li><li>II – No Urgente e Importante (planificar tiempo para hacer).</li><li>III – Urgente y No Importante (intentar delegar o minimizar).</li><li>IV – No Urgente y No Importante (evitar en lo posible).</li></ul>",
    "inst_4": "I – Urgente e Importante (hacer de inmediato).",
    "inst_5": "II – No Urgente e Importante (planificar tiempo para hacer).",
    "inst_6": "III – Urgente y No Importante (intentar delegar o minimizar).",
    "inst_7": "IV – No Urgente y No Importante (evitar en lo posible).",
    "inst_8": "✅ <strong>Marca las Completadas:</strong> A medida que termines cada tarea, márcala como realizada con la casilla de verificación.",
    "inst_9": "🔄 <strong>Vista de Roles/Cuadrantes:</strong> Alterna entre la vista agrupada por roles o por cuadrantes usando las pestañas para obtener diferentes perspectivas de tus tareas.",
    "inst_10": "📊 <strong>Revisa tus Métricas:</strong> Al finalizar la semana, revisa el resumen de tareas completadas y pendientes, y reflexiona sobre tu semana en Revisión Semanal.",
    "inst_11": "📋 <strong>Exporta y Reinicia:</strong> Guarda un registro de tu semana utilizando Exportar Métricas y Exportar Tareas. Luego comienza una nueva semana con el botón Nueva Semana: solo las tareas completadas se removerán, las pendientes permanecerán para la siguiente semana.",
    "label_task": "Nueva Tarea:",
    "label_review": "📝 Revisión semanal:",
    "no_tasks": "No hay tareas asignadas",
    "no_tasks_simple": "Sin tareas",
    "placeholder_review": "Escribe aquí una reflexión sobre tu semana...",
    "metrics_summary": "📋 Tareas Totales: {total}, ✅ Completadas: {done}, ⏳ Pendientes: {pending}, 📈 Porcentaje completado: {percent}%",
    "chart_title_quadrants": "Tareas por Cuadrante",
    "chart_title_completion": "Completadas vs Pendientes",
    "add_role": "➕ Añadir Rol",
    "add_task_button": " ✔️ Añadir Tarea",
    "chart_completion_title": "Porcentaje de Completado por Semana",
    "chart_quadrants_title": "Tareas por Cuadrante por Semana",
    "chart_roles_title": "Roles Activos por Semana",
    "instructions_title": "📖 Instrucciones de uso",
    "metric_percent": "Porcentaje Completado",
    "metric_quadrants": "Tareas por Cuadrante",
    "metric_roles": "Roles Activos",
    "metric_total": "Total de Tareas",
    "placeholder_role": "Nuevo rol...",
    "placeholder_task": "Descripción de la tarea",
    "metric_completed": "Completadas",
    "metric_pending": "Pendientes"
  },
  "en": {
    "title": "Weekly Planner",
    "subtitle": "Plan your week with clarity and purpose",
    "new_task": "New task",
    "add_task": "Add task",
    "roles": "Define Roles",
    "review": "Weekly Review",
    "new_week": "🌅 New Week",
    "export_metrics": "📥 Export Metrics",
    "export_tasks": "📥 Export Tasks",
    "instructions": "How to Use",
    "tabs_roles": "By Roles",
    "tabs_quadrants": "By Quadrants",
    "inst_1": "🎭 <strong>Define Your Roles:</strong> Identify the key roles in your life (e.g., Parent, Professional, Friend). These will be used to organize your weekly tasks.",
    "inst_2": "📝 <strong>Add Your Tasks:</strong> For each role, add tasks you want to complete this week. Write a short description and assign it to a priority quadrant.",
    "inst_3": "🔢 <strong>Prioritize with Quadrants:</strong> Use the Priority Matrix (I-IV) to classify each task:",
    "inst_3_sub": "<ul class='list-none ml-4 mt-1'><li>I – Urgent and Important (do immediately).</li><li>II – Not Urgent but Important (schedule time to do).</li><li>III – Urgent but Not Important (try to delegate or minimize).</li><li>IV – Not Urgent and Not Important (avoid if possible).</li></ul>",
    "inst_4": "I – Urgent and Important (do immediately).",
    "inst_5": "II – Not Urgent but Important (schedule it).",
    "inst_6": "III – Urgent but Not Important (try to delegate or minimize).",
    "inst_7": "IV – Not Urgent and Not Important (avoid if possible).",
    "inst_8": "✅ <strong>Mark Completed Tasks:</strong> As you finish each task, check it off using the checkbox.",
    "inst_9": "🔄 <strong>Roles/Quadrants View:</strong> Switch between the grouped view by roles or by quadrants for different perspectives.",
    "inst_10": "📊 <strong>Review Your Metrics:</strong> At the end of the week, check the summary of completed and pending tasks and reflect using the Weekly Review.",
    "inst_11": "📋 <strong>Export and Reset:</strong> Save a record of your week using Export Metrics and Export Tasks. Then start a new week: only completed tasks will be removed, pending ones will remain.",
    "label_task": "New Task:",
    "label_review": "📝 Weekly Review:",
    "no_tasks": "No tasks assigned",
    "no_tasks_simple": "No tasks",
    "placeholder_review": "Write here your weekly reflection...",
    "metrics_summary": "📋 Total Tasks: {total}, ✅ Completed: {done}, ⏳ Pending: {pending}, 📈 Completion Rate: {percent}%",
    "chart_title_quadrants": "Tasks by Quadrant",
    "chart_title_completion": "Completed vs Pending",
    "add_role": "➕ Add Role",
    "add_task_button": "✔️ Add Task",
    "chart_completion_title": "Weekly Completion Percentage",
    "chart_quadrants_title": "Tasks per Quadrant per Week",
    "chart_roles_title": "Active Roles per Week",
    "instructions_title": "📖 Instructions",
    "metric_percent": "Completion Percentage",
    "metric_quadrants": "Tasks by Quadrant",
    "metric_roles": "Active Roles",
    "metric_total": "Total Tasks",
    "placeholder_role": "New role...",
    "placeholder_task": "Task description",
    "metric_completed": "Completed",
    "metric_pending": "Pending"
  }
};

function applyTranslations(lang) {
  const t = translations[lang] || translations["es"]; // Fallback to Spanish if language not found

  // Update text content for elements with data-i18n attribute
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (t[key]) {
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        el.value = t[key];
      } else {
        // For instruction items, preserve the HTML structure
        if (key.startsWith('inst_')) {
          el.innerHTML = t[key];
        } else {
          el.textContent = t[key];
        }
      }
    }
  });

  // Update placeholders
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (t[key]) el.placeholder = t[key];
  });

  // Update chart titles and labels
  if (typeof chartQuadrants !== "undefined" && chartQuadrants) {
    chartQuadrants.options.plugins.title = {
      display: true,
      text: t.chart_title_quadrants
    };
    chartQuadrants.update();
  }

  if (typeof chartCompletion !== "undefined" && chartCompletion) {
    chartCompletion.data.labels = [t.metric_completed, t.metric_pending];
    chartCompletion.update();
  }

  if (typeof chartHistoricalCompletion !== "undefined" && chartHistoricalCompletion) {
    chartHistoricalCompletion.options.plugins.title = {
      display: true,
      text: t.chart_completion_title
    };
    chartHistoricalCompletion.update();
  }

  if (typeof chartHistoricalQuadrants !== "undefined" && chartHistoricalQuadrants) {
    chartHistoricalQuadrants.options.plugins.title = {
      display: true,
      text: t.chart_quadrants_title
    };
    chartHistoricalQuadrants.update();
  }

  if (typeof chartHistoricalRoles !== "undefined" && chartHistoricalRoles) {
    chartHistoricalRoles.options.plugins.title = {
      display: true,
      text: t.chart_roles_title
    };
    chartHistoricalRoles.update();
  }
}

function setLanguage(lang) {
  localStorage.setItem("habitus_lang", lang);
  
  // Force a complete refresh of all translations
  const t = translations[lang] || translations["es"];
  
  // Update all elements with data-i18n
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (t[key]) {
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        el.value = t[key];
      } else {
        // For instruction items, preserve the HTML structure
        if (key.startsWith('inst_')) {
          el.innerHTML = t[key];
        } else {
          el.textContent = t[key];
        }
      }
    }
  });

  // Update all placeholders
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (t[key]) el.placeholder = t[key];
  });

  // Update inspirational quote
  const elegido = pasajes[lang][Math.floor(Math.random() * pasajes[lang].length)];
  const contenedor = document.getElementById("pasaje-inspirador");
  if (contenedor) {
    contenedor.innerHTML = `
      <div class='text-gray-700 text-center mt-4'>
        <p class='italic mb-1'>"${elegido.contenido}"</p>
        <p class='text-sm text-gray-500'>${elegido.pasaje}</p>
      </div>
    `;
  }

  // Update UI components
  updateRoleOptions();
  renderViews();
  updateCharts();
}

document.addEventListener('DOMContentLoaded', () => {
  const lang = localStorage.getItem("habitus_lang") || "es";
  applyTranslations(lang);
  
  // Register Service Worker
  if ('serviceWorker' in navigator) {
    const currentPath = window.location.pathname;
    const basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
    navigator.serviceWorker.register(basePath + 'sw.js')
      .then(registration => {
        console.log('ServiceWorker registration successful');
      })
      .catch(err => {
        console.log('ServiceWorker registration failed: ', err);
      });
  }

  renderRoleList();
  const addRoleBtn = document.getElementById("addRoleBtn");
  addRoleBtn.onclick = addRole;
  initCharts();
  renderViews();
});

// Add this function to handle instructions toggle
function toggleInstructions() {
  const content = document.getElementById('instructionsContent');
  const toggle = document.getElementById('instructionsToggle');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = '▼';
  } else {
    content.style.display = 'none';
    toggle.textContent = '▶';
  }
}

// Initialize instructions as visible by default
document.addEventListener('DOMContentLoaded', () => {
  const content = document.getElementById('instructionsContent');
  const toggle = document.getElementById('instructionsToggle');
  content.style.display = 'block';
  toggle.textContent = '▼';
  
  // ... rest of your existing DOMContentLoaded code ...
});